#!/usr/bin/env python

"""
This is the simple call to the focuschips functions inside
focuschips.py to create png of the raw focus chips for the exposure images

Felipe Menanteau, June 2014
"""

import os
from qatoolkit import focuschips as focus
import despydb.desdbi

# Get the command line options
opt,arg = focus.cmdline_SQL()
DECam_Name = arg[0]
DECam_Name = os.path.splitext(DECam_Name)[0] # in case we missed the extension

# Decide the name and location of the filename we want to use
# Setup desar queries here for later
section = "db-desoper"
try:
    desdmfile = os.environ["des_services"]
except KeyError:
    desdmfile = None
dbh = despydb.desdbi.DesDbi(desdmfile,section)
cur = dbh.cursor()

#####################################################################
# PART 1 -- Get the archive root -- usually /archive_data/Archive/
#####################################################################
query = "select archive_root from archive_sites where location_name='desardata'"
print "# Getting the archive root name"
print "# Will execute the SQL query:\n********\n** %s\n********" % query
cur.execute(query)
archive_root = cur.fetchone()[0]

###############################################
# PART 2 -- Get the location of the filename
###############################################
query = """select path from filepath_desar f, exposure e where  e.exposurename='%s.fits' and e.id=f.id """ % DECam_Name
print "# Getting the location for %s" % DECam_Name
print "# Will execute the SQL query:\n********\n** %s\n********" % query
cur.execute(query)
filename = cur.fetchone()[0]

# Create the full file name
full_filename = os.path.join(archive_root,filename)
print "# Found file: %s " % full_filename
focus.extract_and_png(full_filename,graylevel=opt.grayscale,outdir=opt.outdir,TNsize=opt.TNsize)
